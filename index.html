<!DOCTYPE html>
<html>
<head>
  <title>rubico.tour</title>
  <meta charset="UTF-8" />
  <meta name="description" content="a tour of rubico" />
  <meta name="keywords" content="functional,programming,javascript,typescript,asynchronous,tour,rubico" />
  <meta property="og:title" content="rubico.tour" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://tour.rubico.land" />
  <meta property="og:image" content="assets/android-chrome-512x512.png" />
  <meta property="og:site_name" content="rubico.tour" />
  <meta property="og:description" content="a tour of rubico" />
  <meta name="twitter:title" content="rubico.tour" />
  <meta name="twitter:description" content="a tour of rubico" />
  <meta name="twitter:image:src" content="assets/android-chrome-512x512.png" />
  <meta name="twitter:domain" content="https://tour.rubico.land" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  <script src="https://unpkg.com/rubico@1/index.js" crossorigin></script>
  <script src="https://unpkg.com/react@16/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone@7.10/babel.min.js" crossorigin></script>
  <script src="lib/codemirror.js"></script>
  <link rel="stylesheet" href="lib/codemirror.css">
  <script src="mode/javascript/javascript.js"></script>
</head>
<body>
<div id="react-root"></div>
<div id="codemirror-test"></div>
<button id="codemirror-test-button">run</button>
<div id="codemirror-test-output"></div>
<script>

const { pipe, tap, get } = rubico

// Babel.registerPlugin('@babel/plugin-transform-typescript')

const trace = tap(console.log)

// (id, code) => CodeMirror
const makeCodeMirror = (id, code) => {
  const codemirror = CodeMirror(
    document.getElementById(id),
    { value: code, mode: 'javascript' },
  )
  codemirror.id = id
  return codemirror
}

// code => html_string_with_code
const generateScriptHTML = code => {
  const script = document.createElement('script')
  // script.innerHTML = code
  script.defer = true
  script.innerHTML = `
const hey = document.createElement('h1')
hey.innerHTML = 'hey'
document.body.appendChild(hey)
`
  return script
}
/*
var console = {
    panel: $(parent.document.body).append('<div>'),
    log: function(m){
        this.panel.prepend('<div>'+m+'</div>');
    },
};
console.log('message');
*/

// HTMLElement => html_doc_string
const toHTMLDocString = el => {
  const div = document.createElement('div')
  const html = document.createElement('html')
  const body = document.createElement('body')
  body.appendChild(el)
  html.appendChild(body)
  div.appendChild(html)
  return div.innerHTML
}

// htmlString => iframe
const iframeInject = codemirror => htmlString => {
  const iframe = document.createElement('iframe')
  iframe.id = codemirror.id + '-iframe'
  iframe.src = `data:text/html;charset=utf-8,${encodeURI(htmlString)}`
  return iframe
}

const runCode = codemirror => pipe([
  () => codemirror.getValue(),
  code => Babel.transform(code, {}),
  get('code'),
  generateScriptHTML,
  toHTMLDocString,
  iframeInject(codemirror),
  iframe => {
    const existingIFrame = document.getElementById(iframe.id)
    if (existingIFrame) {
      document.body.replaceChild(iframe, existingIFrame)
    } else {
      document.body.appendChild(iframe)
    }
  },
])

const testMirror = makeCodeMirror('codemirror-test', [
  // const add = (a: int, b: int): int => a + b
  'const add = (a, b) => a + b',
].join('\n'))

document.getElementById('codemirror-test-button').onclick = runCode(testMirror)

// capture console log of iframe and append html - https://stackoverflow.com/a/14925056/8993080

</script>
<!--
comment
-->
</body>
</html>
